<div class="card mb-3 shadow-sm border-start border-5" [ngClass]="getBorderClass()">
  <div class="card-body p-3">
    <div class="d-flex justify-content-between align-items-start mb-2">
      <div style="cursor: pointer;" [routerLink]="['/tasks', task.id]">
        <h5 class="card-title mb-1 text-primary">{{ task.name }}</h5>
        <span class="fw-bold text-secondary small">#{{ task.id.slice(0, 8) }}</span>
      </div>
      <span class="badge rounded-pill" [ngClass]="getPriorityBadgeClass()">
        {{ priorityMap[task.priority] }}
      </span>
    </div>

    <p class="card-text text-muted small mb-2" *ngIf="task.description">{{ task.description }}</p>

    <div class="mb-2 small">
      <div class="d-flex justify-content-between text-muted">
        <span>تاريخ الإنشاء:</span>
        <span>{{ task.createdAt | date:'shortDate' }}</span>
      </div>
      <div class="d-flex justify-content-between text-muted" *ngIf="task.startDate">
        <span>تاريخ البدء:</span>
        <span>{{ task.startDate | date:'shortDate' }}</span>
      </div>
    </div>

    <p class="mb-1 text-muted small">الطالب: <span class="fw-medium text-dark">{{ task.requestingParty }}</span></p>
    <p class="mb-1 text-muted small">القسم: <span class="fw-medium text-dark">{{ task.currentDepartment }}</span></p>
    <p class="mb-1 text-muted small" *ngIf="task.assignedTo">المكلف: <span class="fw-medium text-primary">{{
        userMap[task.assignedTo] || 'Unknown' }}</span></p>

    <div class="mt-2 d-flex justify-content-between small text-secondary">
      <span>المخطط: {{ task.plannedTime }} يوم</span>
      <span [class.fw-bold]="isDelayed()" [class.text-danger]="isDelayed()">الفعلي: {{ task.actualTime }} يوم</span>
    </div>

    <div *ngIf="task.obstacle" class="mt-2 p-2 bg-danger-subtle text-danger rounded small border border-danger-subtle">
      <strong>عقبة:</strong> {{ task.obstacle }}
    </div>

    <div class="mt-3 d-flex flex-wrap gap-2">
      <!-- Actions based on state -->
      <button *ngIf="task.status === TaskStatus.NEW && canPerformAction('submitForReview')"
        (click)="onAction('submitForReview')" class="btn btn-sm btn-primary">
        إرسال للمراجعة
      </button>

      <button *ngIf="task.status === TaskStatus.UNDER_REVIEW && canPerformAction('approveCredit')"
        (click)="onAction('approveCredit')" class="btn btn-sm btn-primary">
        موافقة الائتمان
      </button>

      <button
        *ngIf="task.currentDepartment === 'Production' && task.status === TaskStatus.IN_PROGRESS && canPerformAction('reportObstacle')"
        (click)="onAction('reportObstacle')" class="btn btn-sm btn-danger">
        إبلاغ عن عقبة
      </button>

      <button
        *ngIf="task.currentDepartment === 'Production' && task.status === TaskStatus.IN_PROGRESS && canPerformAction('completeProduction')"
        (click)="onAction('completeProduction')" class="btn btn-sm btn-success">
        إكمال الإنتاج
      </button>

      <button *ngIf="task.status === TaskStatus.BLOCKED && canPerformAction('resolveObstacle')"
        (click)="onAction('resolveObstacle')" class="btn btn-sm btn-warning text-dark">
        حل العقبة
      </button>

      <button *ngIf="task.status === TaskStatus.COMPLETED && canPerformAction('closeTask')"
        (click)="onAction('closeTask')" class="btn btn-sm btn-dark">
        إغلاق المهمة
      </button>
    </div>
  </div>
</div>